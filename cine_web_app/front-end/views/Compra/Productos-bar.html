<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos Bar</title>
    <link rel="stylesheet" href="/cine_web_app/front-end/css/header.css">
    <link rel="stylesheet" href="/cine_web_app/front-end/css/Productos.css">
    <link rel="stylesheet" href="/cine_web_app/front-end/css/Scrollbar.css">
</head>

<body>
    <!-- Encabezado principal -->
    <header class="header header--desktop">
        <a href="/cine_web_app/front-end/views/home.html" class="header__logo">Elixium</a>
        <nav class="header__nav">
            <ul class="header__menu">
                <li class="header__menu-item"><a href="/cine_web_app/front-end/views/Cinemas.html">Cines</a></li>
                <li class="header__menu-item"><a href="#">Películas</a></li>
                <li class="header__menu-item"><a href="#">Promociones</a></li>
            </ul>
        </nav>
        <div class="header__actions">
            <a href="/cine_web_app/front-end/views/security/register.html"
                class="header__link header__register">Registrarse</a>
            <a href="/cine_web_app/front-end/views/security/login.html" class="header__link header__login">Iniciar
                sesión</a>
        </div>
    </header>

    <!-- Sección de detalles de la película -->
    <section class="movie-details">
        <div class="movie-details__backdrop">
            <!-- Imagen de fondo de la película -->
            <img src="" alt="Banner de la película" class="movie-details__background-image">
        </div>

        <div class="movie-details__content-wrapper flex">
            <div class="movie-details__info-wrapper movie-details__info-wrapper--poster">
                <div class="movie-title">
                    <h2 class="movie-title__text movie__title"></h2>
                </div>
            </div>

            <div class="movie-details__session-info">
                <div class="session-info-container">
                    <div class="session-details">
                        <!-- La información de la sesión (cine, fecha y sala) se insertará aquí -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Sección de productos del bar -->
    <main class="products-bar">
        <h2 class="products-bar__title">Productos Bar</h2>
        <p class="products-bar__description">
            Compra ahora tus productos de bar y podrás recogerlos el día de la sesión en una cola rápida especial en el
            bar del cine.
        </p>
        <button type="button" class="products-bar__allergies" id="allergies-button">
            Alérgenos y recogida de productos
        </button>



        <!-- Contenedor de categorías -->
        <nav class="products-bar__categories">
            <ul>
                <li><a href="#">Top Ventas</a></li>
                <li><a href="#">Menus</a></li>
                <li><a href="#">Palomitas</a></li>
                <li><a href="#">Bebidas</a></li>
                <li><a href="#">Hot Food</a></li>
                <li><a href="#">Merchandising</a></li>
                <li><a href="#">Snacks Dulces</a></li>
            </ul>
        </nav>

        <!-- Contenedor de productos -->
        <section class="products-bar__items">

        </section>

        <div id="total-container" class="total-display">
            <span class="total-label">Total:</span>
            <span id="total-value" class="total-value">0.00 €</span>
        </div>

        <!-- Botón de continuar -->
        <div class="button__contaiter">
            <button id="continue-btn" class="continue-btn">Continuar</button>
        </div>

        <div id="modal" class="modal">
            <div class="modal__content">
                <button id="modal-close" class="modal__close-btn">&times;</button>
                <h2>ALÉRGENOS Y RECOGIDA DE PRODUCTOS</h2>
                <p>
                    Consulta aquí la <a href="/cine_web_app/front-end/views/Compra/Alergenos.html" target="_blank">lista
                        de alérgenos</a> de nuestros productos de bar.
                </p>
                <h3>¿Cómo recojo mi pedido?</h3>
                <ol>
                    <li><strong>Haz tu pedido online:</strong> Elige tu menú favorito, las palomitas, los snacks y la
                        bebida.</li>
                    <li><strong>Avísanos cuando estés en el cine:</strong> Haz clic en el enlace de recogida del pedido
                        que aparece en el email que te llegó con las entradas para que vayamos preparando todo.</li>
                    <li><strong>¡Todo cocina!</strong> Acércate al bar para recoger tu pedido y ¡a disfrutar!</li>
                </ol>
            </div>
        </div>



    </main>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const params = new URLSearchParams(window.location.search);

            // Referencias de elementos
            const movieTitleElement = document.querySelector('.movie-title__text');
            const sessionDetailsElement = document.querySelector('.session-details');
            const bannerImageElement = document.querySelector('.movie-details__background-image');
            const totalValueElement = document.getElementById('total-value'); // Elemento para mostrar el total

            // Renderizar el precio de las entradas desde los parámetros de la URL
            let ticketTotal = parseFloat(params.get('totalPrice')) || 0; // Precio total inicial de las entradas
            let cartTotal = ticketTotal; // Inicializar el total del carrito con el precio de las entradas

            // Función para actualizar el total en la interfaz
            const updateTotalDisplay = () => {
                if (totalValueElement) {
                    totalValueElement.textContent = `${cartTotal.toFixed(2)} €`;
                }
            };

            // Inicializar total en la interfaz
            updateTotalDisplay();

            // Mostrar información de la película
            if (movieTitleElement) {
                movieTitleElement.textContent = params.get('movieTitle') || "SIN TÍTULO";
            }

            if (sessionDetailsElement) {
                sessionDetailsElement.innerHTML = `
            <p>CINE: ${params.get('cineName') || "Sin cine"}</p>
            <p>SESIÓN: ${params.get('date') || "Fecha no disponible"}, ${params.get('time') || "Hora no disponible"}</p>
        `;
            }

            if (bannerImageElement) {
                const bannerImage = params.get('bannerImage');
                if (bannerImage) {
                    bannerImageElement.src = bannerImage;
                } else {
                    console.warn("No se proporcionó una imagen de banner.");
                }
            }

            const productsContainer = document.querySelector('.products-bar__items');
            const categoriesContainer = document.querySelector('.products-bar__categories ul');

            // Función para cargar productos por categoría
            const loadProducts = async (category = "") => {
                try {
                    const response = await fetch(`http://localhost:5006/api/Productos/GetProductos?categoria=${encodeURIComponent(category)}`);
                    if (!response.ok) throw new Error("Error al cargar productos del bar");

                    const productos = await response.json();
                    if (!productsContainer) {
                        console.error("Contenedor de productos no encontrado.");
                        return;
                    }

                    productsContainer.innerHTML = ""; // Limpiar productos previos

                    if (productos.length === 0) {
                        productsContainer.innerHTML = `
                    <p class="no-products-message">No hay productos disponibles en esta categoría.</p>
                `;
                        return;
                    }

                    productos.forEach(product => {
                        const productCard = document.createElement('div');
                        productCard.className = 'product-card__button';
                        productCard.innerHTML = `
                    <div class="product-card__image-container">
                        <img src="${product.imagenUrl}" alt="${product.nombre}" class="product-card__image">
                    </div>
                    <div class="product-card__details">
                        <span class="product-card__name">${product.nombre}</span>
                        <span class="product-card__price">${product.precio.toFixed(2)} €</span>
                        <button class="product-card__add-button" data-price="${product.precio.toFixed(2)}">Añadir a tu compra</button>
                    </div>
                    <p class="product-card__description">Consulta los alérgenos en nuestra web o pregunta al personal.</p>
                `;
                        productsContainer.appendChild(productCard);
                    });

                    // Añadir eventos a los botones "Añadir a tu compra"
                    const addButtons = document.querySelectorAll('.product-card__add-button');
                    addButtons.forEach(button => {
                        button.addEventListener('click', () => {
                            const productPrice = parseFloat(button.getAttribute('data-price')); // Obtener el precio del producto
                            cartTotal += productPrice; // Actualizar el total del carrito
                            updateTotalDisplay(); // Actualizar el total en la interfaz
                        });
                    });
                } catch (error) {
                    console.error("Error al cargar productos:", error);
                }
            };

            // Función para cargar categorías
            const loadCategories = async () => {
                try {
                    const response = await fetch("http://localhost:5006/api/Productos/GetCategorias");
                    if (!response.ok) throw new Error("Error al cargar categorías");

                    const categorias = await response.json();
                    if (!categoriesContainer) {
                        console.error("Contenedor de categorías no encontrado.");
                        return;
                    }

                    categoriesContainer.innerHTML = ""; // Limpiar categorías previas

                    categorias.forEach(category => {
                        const categoryItem = document.createElement("li");
                        const categoryLink = document.createElement("a");
                        categoryLink.textContent = category;
                        categoryLink.href = "#";
                        categoryLink.className = "category-link";
                        categoryLink.dataset.category = category;

                        // Al hacer clic en una categoría, cargar productos de esa categoría
                        categoryLink.addEventListener("click", async (e) => {
                            e.preventDefault();
                            await loadProducts(category); // Filtrar por la categoría seleccionada
                            document.querySelectorAll(".category-link").forEach(link => link.classList.remove("active"));
                            categoryLink.classList.add("active");
                        });

                        categoryItem.appendChild(categoryLink);
                        categoriesContainer.appendChild(categoryItem);
                    });

                    // Seleccionar la primera categoría por defecto
                    if (categorias.length > 0) {
                        const firstCategoryLink = categoriesContainer.querySelector('.category-link');
                        if (firstCategoryLink) {
                            firstCategoryLink.classList.add('active');
                            await loadProducts(categorias[0]); // Cargar productos de la primera categoría
                        }
                    }
                } catch (error) {
                    console.error("Error al cargar categorías:", error);
                }
            };

            // Cargar categorías
            await loadCategories();

            // Modal Logic
            const allergiesButton = document.getElementById("allergies-button");
            const modal = document.getElementById("modal");
            const modalClose = document.getElementById("modal-close");

            if (allergiesButton && modal && modalClose) {
                // Función para abrir el modal
                const openModal = () => {
                    modal.classList.add("visible");
                    document.body.style.overflow = "hidden"; // Evita el scroll en el fondo
                };

                // Función para cerrar el modal
                const closeModal = () => {
                    modal.classList.remove("visible");
                    document.body.style.overflow = "auto"; // Restaura el scroll
                };

                // Evento para abrir el modal al hacer clic en el botón
                allergiesButton.addEventListener("click", openModal);

                // Evento para cerrar el modal al hacer clic en el botón de cerrar
                modalClose.addEventListener("click", closeModal);

                // Cerrar el modal al hacer clic fuera del contenido
                modal.addEventListener("click", (e) => {
                    if (e.target === modal) closeModal();
                });
            } else {
                console.warn("No se encontraron elementos para el modal.");
            }

            // Botón continuar
            const continueButton = document.getElementById("continue-btn");
            if (continueButton) {
                continueButton.addEventListener("click", () => {
                    window.location.href = `/cine_web_app/front-end/views/summary.html?${params.toString()}`;
                });
            }
        });


    </script>




    <script src="/cine_web_app/front-end/js/Cine/SeatSelection.js"></script>
    <script src="/cine_web_app/front-end/js/Compra/productos-bar.js"></script>

</body>

</html>